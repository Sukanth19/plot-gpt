<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOVIE_RECOMMENDER.EXE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --green: #00ff00;
            --green-dim: #00cc00;
            --green-dark: #004400;
            --green-glow: rgba(0,255,0,0.3);
            --bg: #000;
            --panel: rgba(0,20,0,0.95);
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--bg);
            color: var(--green);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ── CRT scanlines overlay ── */
        body::before {
            content: "";
            position: fixed; inset: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.08) 2px,
                rgba(0,0,0,0.08) 4px
            );
            pointer-events: none;
            z-index: 9999;
        }

        /* ── Animations ── */
        @keyframes glow {
            0%,100% { text-shadow: 0 0 4px var(--green), 0 0 8px var(--green); }
            50%      { text-shadow: 0 0 8px var(--green), 0 0 20px var(--green), 0 0 35px var(--green); }
        }
        @keyframes blink { 0%,49%{opacity:1} 50%,100%{opacity:0} }
        @keyframes fadeUp {
            from { opacity:0; transform:translateY(12px); }
            to   { opacity:1; transform:translateY(0); }
        }
        @keyframes pulse-border {
            0%,100% { box-shadow: 0 0 6px var(--green-glow); }
            50%      { box-shadow: 0 0 18px var(--green-glow), inset 0 0 8px rgba(0,255,0,0.05); }
        }
        @keyframes scan {
            0%   { background-position: 0 -100vh; }
            100% { background-position: 0  100vh; }
        }

        /* ── Layout ── */
        .app-shell {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            padding: 12px;
            gap: 12px;
        }

        /* ── Header ── */
        .topbar {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            border: 1px solid var(--green);
            padding: 10px 20px;
            background: var(--panel);
            animation: pulse-border 4s infinite;
        }
        .topbar-left { font-size: 0.85em; color: var(--green-dim); }
        .topbar-title {
            text-align: center;
            font-family: 'VT323', monospace;
            font-size: 2.2em;
            animation: glow 3s infinite;
            letter-spacing: 4px;
        }
        .topbar-right {
            text-align: right;
            font-size: 0.85em;
            color: var(--green-dim);
        }
        .topbar-right span { animation: blink 1s infinite; }

        /* ── 3-Column Body ── */
        .body-grid {
            display: grid;
            grid-template-columns: 320px 1fr 300px;
            gap: 12px;
            overflow: hidden;
        }

        /* ── Panels ── */
        .panel {
            border: 1px solid var(--green);
            background: var(--panel);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel-header {
            font-family: 'VT323', monospace;
            font-size: 1.4em;
            padding: 10px 14px;
            border-bottom: 1px solid var(--green);
            background: rgba(0,255,0,0.06);
            letter-spacing: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .panel-header .badge {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.6em;
            padding: 3px 8px;
            border: 1px solid var(--green);
            color: var(--green-dim);
        }
        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ── Scrollbar ── */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--green-dim); }

        /* ── Search ── */
        .search-wrapper { position: relative; flex-shrink: 0; }
        .search-input {
            width: 100%;
            padding: 10px 12px 10px 28px;
            background: #000;
            border: 1px solid var(--green);
            color: var(--green);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.95em;
            outline: none;
            transition: box-shadow 0.2s;
        }
        .search-input::placeholder { color: #005500; }
        .search-input:focus { box-shadow: 0 0 14px var(--green-glow); }
        .search-prefix {
            position: absolute;
            left: 10px; top: 50%;
            transform: translateY(-50%);
            color: var(--green-dim);
            pointer-events: none;
        }

        /* ── Dropdown results ── */
        .dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0; right: 0;
            background: #000;
            border: 1px solid var(--green);
            max-height: 320px;
            overflow-y: auto;
            z-index: 500;
            box-shadow: 0 8px 30px rgba(0,255,0,0.25);
            display: none;
        }
        .dropdown.open { display: block; }
        .dropdown-item {
            padding: 10px 12px;
            border-bottom: 1px solid #001a00;
            cursor: pointer;
            transition: background 0.15s, padding-left 0.15s;
        }
        .dropdown-item:hover {
            background: rgba(0,255,0,0.1);
            padding-left: 18px;
        }
        .dropdown-item .d-title { font-size: 0.95em; }
        .dropdown-item .d-meta  { font-size: 0.78em; color: var(--green-dim); margin-top: 2px; }

        /* ── Watched list ── */
        .watched-list { display: flex; flex-direction: column; gap: 8px; }
        .watched-card {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border: 1px solid #003300;
            background: rgba(0,255,0,0.03);
            animation: fadeUp 0.3s ease;
            transition: border-color 0.2s, background 0.2s;
        }
        .watched-card:hover {
            border-color: var(--green);
            background: rgba(0,255,0,0.07);
        }
        .watched-card .wc-title { font-size: 0.9em; line-height: 1.3; }
        .watched-card .wc-meta  { font-size: 0.75em; color: var(--green-dim); margin-top: 3px; }
        .btn-x {
            background: none;
            border: 1px solid #440000;
            color: #ff3333;
            padding: 4px 8px;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8em;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .btn-x:hover { border-color: #ff3333; background: rgba(255,0,0,0.1); box-shadow: 0 0 10px rgba(255,0,0,0.3); }

        /* ── Empty state ── */
        .empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #004400;
            gap: 8px;
            padding: 30px 0;
            font-size: 0.9em;
            text-align: center;
        }
        .empty-icon { font-size: 2.5em; animation: blink 2s infinite; }

        /* ── Middle panel: Controls + Results ── */
        .mid-panel { display: flex; flex-direction: column; gap: 12px; overflow: hidden; }

        .controls-bar {
            border: 1px solid var(--green);
            background: var(--panel);
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-shrink: 0;
        }
        .controls-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
            align-items: end;
        }
        .ctrl-group { display: flex; flex-direction: column; gap: 6px; }
        .ctrl-label {
            font-size: 0.78em;
            color: var(--green-dim);
            display: flex;
            justify-content: space-between;
        }
        .ctrl-label span { color: var(--green); font-weight: bold; }

        input[type=range] {
            width: 100%;
            height: 4px;
            background: #001a00;
            border: none;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; height: 14px;
            background: var(--green);
            border-radius: 0;
            box-shadow: 0 0 8px var(--green);
            cursor: pointer;
        }

        .btn-run {
            width: 100%;
            padding: 12px;
            background: rgba(0,255,0,0.08);
            border: 1px solid var(--green);
            color: var(--green);
            font-family: 'VT323', monospace;
            font-size: 1.5em;
            cursor: pointer;
            letter-spacing: 3px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            animation: pulse-border 3s infinite;
        }
        .btn-run::after {
            content: '';
            position: absolute;
            top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,0,0.15), transparent);
            transition: left 0.4s;
        }
        .btn-run:hover::after { left: 100%; }
        .btn-run:hover { background: rgba(0,255,0,0.15); box-shadow: 0 0 25px var(--green-glow); }
        .btn-run:disabled { opacity: 0.4; cursor: not-allowed; }

        /* ── Sort tabs ── */
        .sort-tabs {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .sort-tab {
            padding: 6px 14px;
            border: 1px solid #003300;
            color: var(--green-dim);
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
            background: none;
            font-family: 'Share Tech Mono', monospace;
        }
        .sort-tab:hover { border-color: var(--green); color: var(--green); }
        .sort-tab.active { border-color: var(--green); color: var(--green); background: rgba(0,255,0,0.08); }

        /* ── Results ── */
        .results-panel {
            flex: 1;
            border: 1px solid var(--green);
            background: var(--panel);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .results-header {
            padding: 10px 14px;
            border-bottom: 1px solid var(--green);
            background: rgba(0,255,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .results-title { font-family: 'VT323', monospace; font-size: 1.4em; letter-spacing: 2px; }
        .results-body { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }

        /* ── Rec card ── */
        .rec-card {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            padding: 12px 14px;
            border: 1px solid #002200;
            background: rgba(0,255,0,0.02);
            cursor: pointer;
            transition: all 0.2s;
            animation: fadeUp 0.3s ease both;
        }
        .rec-card:hover {
            border-color: var(--green);
            background: rgba(0,255,0,0.08);
            padding-left: 20px;
        }
        .rec-title { font-size: 0.95em; line-height: 1.3; margin-bottom: 4px; }
        .rec-genres { font-size: 0.75em; color: var(--green-dim); }
        .rec-right { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
        .score-pill {
            padding: 4px 10px;
            background: var(--green);
            color: #000;
            font-size: 0.78em;
            font-weight: bold;
            white-space: nowrap;
        }
        .rec-year { font-size: 0.78em; color: var(--green-dim); }

        /* score bar */
        .score-bar-wrap { height: 3px; background: #001a00; margin-top: 6px; }
        .score-bar { height: 100%; background: var(--green); box-shadow: 0 0 6px var(--green); transition: width 0.5s; }

        /* ── Right panel: Genre + Stats ── */
        .right-col { display: flex; flex-direction: column; gap: 12px; overflow: hidden; }

        /* ── Genre grid ── */
        .genre-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }
        .genre-chip {
            padding: 7px 6px;
            border: 1px solid #002a00;
            text-align: center;
            cursor: pointer;
            font-size: 0.78em;
            transition: all 0.2s;
            color: var(--green-dim);
            user-select: none;
        }
        .genre-chip:hover { border-color: var(--green); color: var(--green); background: rgba(0,255,0,0.05); }
        .genre-chip.active {
            border-color: var(--green);
            color: #000;
            background: var(--green);
            box-shadow: 0 0 10px var(--green-glow);
        }
        .genre-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .btn-sm {
            flex: 1;
            padding: 7px;
            background: none;
            border: 1px solid #003300;
            color: var(--green-dim);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.78em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-sm:hover { border-color: var(--green); color: var(--green); background: rgba(0,255,0,0.06); }

        /* ── Stats ── */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .stat-card {
            border: 1px solid #002a00;
            padding: 12px 8px;
            text-align: center;
            background: rgba(0,255,0,0.03);
        }
        .stat-val {
            font-family: 'VT323', monospace;
            font-size: 2.2em;
            line-height: 1;
            animation: glow 3s infinite;
        }
        .stat-lbl { font-size: 0.7em; color: var(--green-dim); margin-top: 4px; letter-spacing: 1px; }

        /* ── Loading ── */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex: 1;
            color: var(--green-dim);
        }
        .loading-bar {
            width: 200px; height: 4px;
            background: #001a00;
            position: relative;
            overflow: hidden;
        }
        .loading-bar::after {
            content: '';
            position: absolute;
            height: 100%;
            width: 40%;
            background: var(--green);
            box-shadow: 0 0 10px var(--green);
            animation: load 1s linear infinite;
        }
        @keyframes load {
            0%  { left: -40%; }
            100%{ left: 100%; }
        }

        /* ── Responsive ── */
        @media (max-width: 1100px) {
            .body-grid { grid-template-columns: 280px 1fr; }
            .right-col { display: none; }
        }
        @media (max-width: 720px) {
            .body-grid { grid-template-columns: 1fr; }
            .body-grid > .panel:first-child { display: none; }
            .controls-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="app-shell">

    <!-- ── TOP BAR ── -->
    <header class="topbar">
        <div class="topbar-left">
            SYS: ONLINE &nbsp;|&nbsp; MEM: OK &nbsp;|&nbsp; v2.1
        </div>
        <div class="topbar-title">▌MOVIE_RECOMMENDER.EXE▐</div>
        <div class="topbar-right">
            <span id="clock">00:00:00</span> &nbsp;|&nbsp; ROOT@CINEMADB
        </div>
    </header>

    <!-- ── BODY ── -->
    <div class="body-grid">

        <!-- ══ LEFT: WATCHED MOVIES ══ -->
        <div class="panel">
            <div class="panel-header">
                &gt; WATCHED.DB
                <span class="badge" id="watchedCount">0 ENTRIES</span>
            </div>
            <div class="panel-body">
                <!-- Search -->
                <div class="search-wrapper">
                    <span class="search-prefix">&gt;</span>
                    <input
                        class="search-input"
                        id="movieSearch"
                        type="text"
                        placeholder="SEARCH_TITLE..."
                        autocomplete="off"
                    >
                    <div class="dropdown" id="dropdown"></div>
                </div>

                <!-- List -->
                <div class="watched-list" id="watchedList">
                    <div class="empty">
                        <div class="empty-icon">[ ]</div>
                        <div>NO ENTRIES FOUND</div>
                        <div style="color:#003300">SEARCH TO ADD MOVIES</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ══ MIDDLE ══ -->
        <div class="mid-panel">

            <!-- Controls -->
            <div class="controls-bar">
                <div class="controls-row">
                    <div class="ctrl-group">
                        <div class="ctrl-label">DIVERSITY <span id="lblDiv">0.3</span></div>
                        <input type="range" min="0" max="1" step="0.1" value="0.3" id="slDiv">
                        <div style="font-size:0.7em;color:#004400;display:flex;justify-content:space-between;">
                            <span>SIMILAR</span><span>DIVERSE</span>
                        </div>
                    </div>
                    <div class="ctrl-group">
                        <div class="ctrl-label">MIN SCORE <span id="lblMin">0.0</span></div>
                        <input type="range" min="0" max="1" step="0.05" value="0" id="slMin">
                        <div style="font-size:0.7em;color:#004400;display:flex;justify-content:space-between;">
                            <span>ALL</span><span>STRICT</span>
                        </div>
                    </div>
                    <div class="ctrl-group">
                        <div class="ctrl-label">RESULTS <span id="lblN">15</span></div>
                        <input type="range" min="5" max="50" step="5" value="15" id="slN">
                        <div style="font-size:0.7em;color:#004400;display:flex;justify-content:space-between;">
                            <span>5</span><span>50</span>
                        </div>
                    </div>
                </div>
                <button class="btn-run" id="btnRun" onclick="getRecommendations()">
                    ▶ EXECUTE RECOMMENDATION ALGORITHM ◀
                </button>
            </div>

            <!-- Results -->
            <div class="results-panel">
                <div class="results-header">
                    <div class="results-title">&gt; RESULTS.OUT</div>
                    <div class="sort-tabs">
                        <button class="sort-tab active" onclick="setSortTab(this,'score')">SCORE</button>
                        <button class="sort-tab" onclick="setSortTab(this,'year')">YEAR</button>
                        <button class="sort-tab" onclick="setSortTab(this,'title')">A–Z</button>
                    </div>
                </div>
                <div class="results-body" id="results">
                    <div class="empty" style="flex:1">
                        <div class="empty-icon">[?]</div>
                        <div>AWAITING INPUT</div>
                        <div style="color:#003300">ADD MOVIES → EXECUTE</div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ══ RIGHT: GENRE + STATS ══ -->
        <div class="right-col">

            <!-- Genre filter -->
            <div class="panel" style="flex:1">
                <div class="panel-header">
                    &gt; GENRE.FILTER
                    <span class="badge" id="genreCount">0 SEL</span>
                </div>
                <div class="panel-body">
                    <div class="genre-actions">
                        <button class="btn-sm" onclick="selectAllGenres()">ALL</button>
                        <button class="btn-sm" onclick="clearGenres()">NONE</button>
                    </div>
                    <div class="genre-grid" id="genreGrid"></div>
                </div>
            </div>

            <!-- Stats -->
            <div class="panel">
                <div class="panel-header">&gt; SYS.STATS</div>
                <div class="panel-body">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-val" id="statWatched">0</div>
                            <div class="stat-lbl">WATCHED</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-val" id="statGenres">0</div>
                            <div class="stat-lbl">GENRES SEL</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-val" id="statTotal">—</div>
                            <div class="stat-lbl">TOTAL FILMS</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-val" id="statResults">0</div>
                            <div class="stat-lbl">MATCHES</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div><!-- /body-grid -->
</div><!-- /app-shell -->

<script>
/* ─────────────────────────────────────────
   STATE
───────────────────────────────────────── */
let watchedMovies  = [];   // [id, ...]
let watchedDetails = {};   // {id: movieObj}
let selectedGenres = [];
let allGenres      = [];
let allRecs        = [];
let currentSort    = 'score';
let searchTimer;

/* ─────────────────────────────────────────
   CLOCK
──────────────────────���────────────────── */
function tick() {
    const now = new Date();
    document.getElementById('clock').textContent =
        now.toTimeString().slice(0,8);
}
tick(); setInterval(tick, 1000);

/* ─────────────────────────────────────────
   INIT
───────────────────────────────────────── */
async function init() {
    const [genreRes, statsRes] = await Promise.all([
        fetch('/api/genres'),
        fetch('/api/stats')
    ]);
    allGenres = await genreRes.json();
    const stats = await statsRes.json();

    document.getElementById('statTotal').textContent =
        stats.total_movies.toLocaleString();

    // Build genre chips
    const grid = document.getElementById('genreGrid');
    grid.innerHTML = allGenres.map(g =>
        `<div class="genre-chip" data-genre="${g}" onclick="toggleGenre('${g}')">${g}</div>`
    ).join('');
}
init();

/* ─────────────────────────────────────────
   SEARCH
───────────────────────────────────────── */
const searchInput = document.getElementById('movieSearch');
const dropdown    = document.getElementById('dropdown');

searchInput.addEventListener('input', e => {
    clearTimeout(searchTimer);
    const q = e.target.value.trim();
    if (q.length < 2) { closeDropdown(); return; }
    searchTimer = setTimeout(() => doSearch(q), 250);
});

searchInput.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeDropdown();
});

document.addEventListener('click', e => {
    if (!e.target.closest('.search-wrapper')) closeDropdown();
});

async function doSearch(q) {
    const res  = await fetch(`/api/movies/search?q=${encodeURIComponent(q)}&limit=25`);
    const data = await res.json();

    if (!data.length) { closeDropdown(); return; }

    dropdown.innerHTML = data.map(m => `
        <div class="dropdown-item" onclick="addMovie(${m.movie_id})">
            <div class="d-title">${m.title}</div>
            <div class="d-meta">${m.genres.join(' · ')} ${m.year ? '· '+m.year : ''}</div>
        </div>
    `).join('');
    dropdown.classList.add('open');
}

function closeDropdown() {
    dropdown.classList.remove('open');
    dropdown.innerHTML = '';
}

/* ─────────────────────────────────────────
   WATCHED LIST
───────────────────────────────────────── */
async function addMovie(id) {
    if (watchedMovies.includes(id)) {
        closeDropdown();
        searchInput.value = '';
        return;
    }
    // fetch details if not cached
    if (!watchedDetails[id]) {
        const res = await fetch(`/api/movies/${id}`);
        watchedDetails[id] = await res.json();
    }
    watchedMovies.push(id);
    searchInput.value = '';
    closeDropdown();
    renderWatched();
    updateStats();
}

function removeMovie(id) {
    watchedMovies = watchedMovies.filter(x => x !== id);
    renderWatched();
    updateStats();
}

function renderWatched() {
    const list = document.getElementById('watchedList');
    document.getElementById('watchedCount').textContent =
        watchedMovies.length + ' ENTRIES';

    if (!watchedMovies.length) {
        list.innerHTML = `
            <div class="empty">
                <div class="empty-icon">[ ]</div>
                <div>NO ENTRIES FOUND</div>
                <div style="color:#003300">SEARCH TO ADD MOVIES</div>
            </div>`;
        return;
    }

    list.innerHTML = watchedMovies.map(id => {
        const m = watchedDetails[id];
        return `
        <div class="watched-card">
            <div>
                <div class="wc-title">${m.title}</div>
                <div class="wc-meta">${m.genres.slice(0,3).join(' · ')}${m.genres.length>3?'…':''}</div>
            </div>
            <button class="btn-x" onclick="removeMovie(${id})">✕</button>
        </div>`;
    }).join('');
}

/* ─────────────────────────────────────────
   GENRES
───────────────────────────────────────── */
function toggleGenre(g) {
    const i = selectedGenres.indexOf(g);
    if (i > -1) selectedGenres.splice(i,1);
    else         selectedGenres.push(g);
    refreshGenreChips();
    updateStats();
}
function selectAllGenres() { selectedGenres = [...allGenres]; refreshGenreChips(); updateStats(); }
function clearGenres()      { selectedGenres = [];             refreshGenreChips(); updateStats(); }
function refreshGenreChips() {
    document.querySelectorAll('.genre-chip').forEach(el => {
        el.classList.toggle('active', selectedGenres.includes(el.dataset.genre));
    });
    document.getElementById('genreCount').textContent = selectedGenres.length + ' SEL';
}

/* ─────────────────────────────────────────
   STATS
───────────────────────────────────────── */
function updateStats() {
    document.getElementById('statWatched').textContent = watchedMovies.length;
    document.getElementById('statGenres').textContent  = selectedGenres.length;
}

/* ──────────────���──────────────────────────
   SLIDERS
───────────────────────────────────────── */
function bindSlider(id, labelId, transform) {
    const el = document.getElementById(id);
    const lb = document.getElementById(labelId);
    el.addEventListener('input', () => { lb.textContent = transform(el.value); });
}
bindSlider('slDiv', 'lblDiv', v => parseFloat(v).toFixed(1));
bindSlider('slMin', 'lblMin', v => parseFloat(v).toFixed(2));
bindSlider('slN',   'lblN',   v => v);

/* ─────────────────────────────────────────
   RECOMMENDATIONS
───────────────────────────────────────── */
async function getRecommendations() {
    if (!watchedMovies.length) {
        flashBtn('ADD MOVIES FIRST'); return;
    }

    const btn = document.getElementById('btnRun');
    btn.disabled = true;
    btn.textContent = '⟳ PROCESSING...';

    showLoading();

    const res = await fetch('/api/recommendations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            watched_ids:      watchedMovies,
            preferred_genres: selectedGenres.length ? selectedGenres : [],
            diversity:        parseFloat(document.getElementById('slDiv').value),
            n:                parseInt(document.getElementById('slN').value),
            year_weight:      0.2
        })
    });

    const data = await res.json();
    const minScore = parseFloat(document.getElementById('slMin').value);
    allRecs = data.filter(r => r.score >= minScore);

    document.getElementById('statResults').textContent = allRecs.length;
    applySortAndRender();

    btn.disabled = false;
    btn.textContent = '▶ EXECUTE RECOMMENDATION ALGORITHM ◀';
}

function showLoading() {
    document.getElementById('results').innerHTML = `
        <div class="loading-state">
            <div>PROCESSING NEURAL NETWORK</div>
            <div class="loading-bar"></div>
            <div style="font-size:0.8em;color:#004400">COMPUTING COSINE SIMILARITIES...</div>
        </div>`;
}

function flashBtn(msg) {
    const btn = document.getElementById('btnRun');
    const orig = btn.textContent;
    btn.textContent = '⚠ ' + msg;
    setTimeout(() => { btn.textContent = orig; }, 1500);
}

/* ─────────────────────────────────────────
   SORT + RENDER
───────────────────────────────────────── */
function setSortTab(el, type) {
    currentSort = type;
    document.querySelectorAll('.sort-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    applySortAndRender();
}

function applySortAndRender() {
    const sorted = [...allRecs];
    if      (currentSort === 'score') sorted.sort((a,b) => b.score - a.score);
    else if (currentSort === 'year')  sorted.sort((a,b) => (b.movie.year||0) - (a.movie.year||0));
    else if (currentSort === 'title') sorted.sort((a,b) => a.movie.title.localeCompare(b.movie.title));
    renderResults(sorted);
}

function renderResults(recs) {
    const box = document.getElementById('results');

    if (!recs.length) {
        box.innerHTML = `
            <div class="empty" style="flex:1">
                <div class="empty-icon">[0]</div>
                <div>NO MATCHES</div>
                <div style="color:#003300">TRY LOWER MIN SCORE</div>
            </div>`;
        return;
    }

    box.innerHTML = recs.map(({ movie, score }, i) => `
        <div class="rec-card" style="animation-delay:${i*0.03}s"
             onclick="addMovie(${movie.movie_id})"
             title="Click to add to watched list">
            <div>
                <div class="rec-title">${movie.title}</div>
                <div class="rec-genres">${movie.genres.join(' · ')}</div>
                <div class="score-bar-wrap">
                    <div class="score-bar" style="width:${(score*100).toFixed(1)}%"></div>
                </div>
            </div>
            <div class="rec-right">
                <div class="score-pill">${(score*100).toFixed(1)}%</div>
                ${movie.year ? `<div class="rec-year">${movie.year}</div>` : ''}
            </div>
        </div>
    `).join('');
}
</script>
</body>
</html>